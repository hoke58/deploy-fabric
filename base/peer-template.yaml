version: '2'

networks:
  fabric:

services:
  peer${NUM}.${PEER_DOMAIN}:
    container_name: peer${NUM}
    extends:
      file:  base/docker-compose-base.yaml
      service: peer-base
    environment:
      # 设置用于标识此Peer节点的id
      - CORE_PEER_ID=peer${NUM}
      # 设置此peer节点所属机构id
      - CORE_PEER_LOCALMSPID=${PEER_MSP}
      - CORE_PEER_ADDRESS=peer${NUM}.${PEER_DOMAIN}:7051
      - CORE_PEER_CHAINCODELISTENADDRESS=peer${NUM}.${PEER_DOMAIN}:7052
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer${NUM}.${PEER_DOMAIN}:7051       
    # 目录映射
    volumes:
      - ./crypto-config/peerOrganizations/${PEER_DOMAIN}/peers/peer${NUM}.${PEER_DOMAIN}/msp:/etc/hyperledger/fabric/msp
      - ./crypto-config/peerOrganizations/${PEER_DOMAIN}/peers/peer${NUM}.${PEER_DOMAIN}/tls:/etc/hyperledger/fabric/tls
      - ./crypto-config/peerOrganizations/${PEER_DOMAIN}/crypto:/etc/hyperledger/fabric/crypto
      - ${MOUNT_DATA}/peer${NUM}:/var/hyperledger/production
    networks:
      - fabric
    extra_hosts:
      ${GENESIS_ORD_ADDRESS}: ${GENESIS_ORD_IP}
      orderer0.${ORDERER_DOMAIN}: ${ORDERER_IP}

  cli${NUM}:
    container_name: cli${NUM}
    extends:
      file:  base/docker-compose-base.yaml
      service: cli-base
    environment:
      - CORE_PEER_ID=cli${NUM}
      - CORE_PEER_LOCALMSPID=${PEER_MSP}
      - CORE_PEER_MSPCONFIGPATH=crypto-config/peerOrganizations/${PEER_DOMAIN}/users/Admin@${PEER_DOMAIN}/msp
      - CORE_PEER_ADDRESS=peer${NUM}.${PEER_DOMAIN}:7051
      - CORE_PEER_TLS_CERT_FILE=crypto-config/peerOrganizations/${PEER_DOMAIN}/peers/peer${NUM}.${PEER_DOMAIN}/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=crypto-config/peerOrganizations/${PEER_DOMAIN}/peers/peer${NUM}.${PEER_DOMAIN}/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=crypto-config/peerOrganizations/${PEER_DOMAIN}/peers/peer${NUM}.${PEER_DOMAIN}/tls/ca.crt
      - ORDERER_ADDRESS=orderer0.${ORDERER_DOMAIN}:7050
      - ORDERER_CA=crypto-config/ordererOrganizations/${ORDERER_DOMAIN}/orderers/orderer0.${ORDERER_DOMAIN}/msp/tlscacerts/tlsca.${ORDERER_DOMAIN}-cert.pem
    volumes:
      - /var/run/:/host/var/run/
      - ${MOUNT_DATA}/cli${NUM}:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts
    depends_on:
      - peer${NUM}.${PEER_DOMAIN}
    networks:
      - fabric
    extra_hosts:
      ${GENESIS_ORD_ADDRESS}: ${GENESIS_ORD_IP}
      orderer0.${ORDERER_DOMAIN}: ${ORDERER_IP}